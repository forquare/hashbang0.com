+++
date = 2017-07-27T21:43:35+01:00
title = "acme.sh, plus Linode, plus DNS, plus FreeBSD"
tags = ["FreeBSD","acme.sh","Let's Encrypt"]
categories =  ["FreeBSD", "web"]
author = "Ben Lavery-Griffiths"
draft = true
+++

I’ve been meaning to use Let’s Encrypt for some time now, I don’t really have a good excuse as to why it’s taken so long, other than I wanted to use DNS to verify I owned the relevant domains, and I hadn’t found an easy enough tool to use.

My lame excuse faltered when [Dan Langille](http://dan.langille.org) ported the [acme.sh](https://github.com/Neilpang/acme.sh) client to [FreeBSD](http://www.freshports.org/security/acme.sh/).

It’s taken me a while to figure out exactly how I aught to use it, as I wasn’t 100% about what I was doing.  But after a few false starts, I’ve placed my first certificates into use!

This post describes the steps I’ve taken to get the certs in place, and is mainly documentation for me later on.  That said, I hope it’s general enough for others to find it helpful.


1. Install the kernel
2. Install userland
3. Cleanup

Usually, one would reboot between these actions.  This is what I had attempted, but when I rebooted into my new BE I got the familiar message:

    No updates are available to install.
    Run '/usr/sbin/freebsd-update fetch' first.

So, what's the correct procedure?  Hunting across the Internet, I found many examples of how people thought it should be done.  Most commonly was:

1. Create a BE
2. Activate the BE
3. Reboot into the BE
4. Fetch the upgrade
5. Install the upgraded kernel
6. Reboot
7. Install upgraded userland
8. Reboot (sometimes this seemed optional)
9. Run install again for cleanup
10. Reboot

Now, that seems like an awful lot of downtime.  Back at Sun, BEs were introduced to me as a convenient roll-back method if things go wrong, and also to reduce downtime caused by upgrade (this was called [Live Upgrade](/2008/11/21/sun---week-twenty/)).  Having all of this downtime did not appeal to me one bit.

So, how can we reduce downtime while using FreeBSD Boot Environments?  Run all three installation tasks one after each other.  Since we are upgrading an essentially dormant system (the BE hasn't been activated and rebooted into yet) we don't need to do the in-between reboots.  Here's my process:

{{% gist forquare 6eab4c53420f4add7f13262e67254e89 %}}

Now you can keep the previous BE around until you're happy everything is working and then destroy it.

I've not tried it, but I see no reason why this wouldn't work for updates (e.g. 11.0-RELEASE-p0 to 11.0-RELEASE-p1) too.
